<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logement √©co-responsable</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
            padding-bottom: 60px; 
        }
        .navbar-custom {
            background-color: #28a745;
        }
        .navbar-custom .navbar-brand, .navbar-custom .nav-link {
            color: #ffffff;
        }
        footer {
            background-color: #343a40;
            color: #ffffff;
            padding: 20px 0;
            position: relative; 
            width: 100%;
            margin-top: 20px; 
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <a class="navbar-brand" href="#">Logement √âco-Responsable</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#">Accueil</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#consommation">Consommation</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#economies">√âconomies R√©alis√©es</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#capteurs">Capteurs/Actionneurs</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#ajout_capteurs">Ajout des Capteurs/Actionneurs</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#configuration">Configuration</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#seuils">Seuils de Consommation et Alertes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#securite">S√©curit√© des Pi√®ces</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#house_overview">Vue d'ensemble</a>
                </li>
            </ul>
        </div>
    </nav>
    <!-- Accueil -->
    <section id="accueil" class="container mt-5">
        <div class="jumbotron text-center">
            <h1>Bienvenue au Logement √âco-Responsable de Yedam KIM</h1>
            <p>Ce projet a pour but de vous aider √† g√©rer votre consommation √©nerg√©tique, vos capteurs, et vos √©conomies de mani√®re efficace et √©cologique.</p>
            <p>Le Logement √âco-Responsable vous permet de :</p>
            <ul class="list-unstyled">
                <li>‚ö° Suivre et optimiser votre consommation d'√©nergie.</li>
                <li>üíß G√©rer l'utilisation de vos ressources telles que l'eau et l'√©lectricit√©.</li>
                <li>üîí Assurer la s√©curit√© de vos diff√©rentes pi√®ces.</li>
                <li>üìä Visualiser vos √©conomies r√©alis√©es gr√¢ce √† des analyses d√©taill√©es.</li>
            </ul>
            <p>Explorez les diff√©rentes sections pour en savoir plus et commencer votre voyage vers un habitat plus durable !</p>
            <p>Yedam KIM TP3 IOT</p>
        </div>
    </section>

    <!-- Consommation -->
    <section id="consommation" class="container mt-5">
        <h2>Consommation</h2>
        <div id="consommation_chart" style="width: 100%; height: 400px;"></div>
    </section>

    <!-- Economies R√©alis√©es -->
    <section id="economies" class="container mt-5">
        <h2>√âconomies R√©alis√©es</h2>
        <div class="btn-group mb-3" role="group" aria-label="Type Factures">
            <button type="button" name="type_fac" value="Eau" class="btn btn-primary" onclick="filterEconomies('Eau')">Eau</button>
            <button type="button" name="type_fac" value="√âlectricit√©" class="btn btn-primary" onclick="filterEconomies('√âlectricit√©')">√âlectricit√©</button>
            <button type="button" name="type_fac" value="Gaz" class="btn btn-primary" onclick="filterEconomies('Gaz')">Gaz</button>
            <button type="button" name="type_fac" value="D√©chets" class="btn btn-primary" onclick="filterEconomies('D√©chets')">D√©chets</button>
            <button type="button" name="type_fac" value="Total" class="btn btn-primary" onclick="filterEconomies('')">Total</button>
        </div>
        <div id="economies_chart" style="width: 100%; height: 400px;"></div>
    </section>

    <!-- Capteurs/Actionneurs -->
    <section id="capteurs" class="container mt-5">
        <h2>Capteurs et Actionneurs</h2>
        <div class="row">
            <!-- Capteur de Temp√©rature -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Capteur de Temp√©rature</h5>
                        <p class="card-text">√âtat : <span>{{ capteur_states['capteur_temp'] }}</span></p>
                        <form method="POST" action="/toggle_capteur">
                            <input type="hidden" name="capteur_id" value="capteur_temp">
                            <button type="submit" class="btn {{ 'btn-success' if capteur_states['capteur_temp'] == 'Actif' else 'btn-danger' }}">
                                {{ 'D√©sactiver' if capteur_states['capteur_temp'] == 'Actif' else 'Activer' }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Capteur d'Humidit√© -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Capteur d'Humidit√©</h5>
                        <p class="card-text">√âtat : <span>{{ capteur_states['capteur_humidite'] }}</span></p>
                        <form method="POST" action="/toggle_capteur">
                            <input type="hidden" name="capteur_id" value="capteur_humidite">
                            <button type="submit" class="btn {{ 'btn-success' if capteur_states['capteur_humidite'] == 'Actif' else 'btn-danger' }}">
                                {{ 'D√©sactiver' if capteur_states['capteur_humidite'] == 'Actif' else 'Activer' }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Capteur de Lumi√®re -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Capteur de Lumi√®re</h5>
                        <p class="card-text">√âtat : <span>{{ capteur_states['capteur_lumiere'] }}</span></p>
                        <form method="POST" action="/toggle_capteur">
                            <input type="hidden" name="capteur_id" value="capteur_lumiere">
                            <button type="submit" class="btn {{ 'btn-success' if capteur_states['capteur_lumiere'] == 'Actif' else 'btn-danger' }}">
                                {{ 'D√©sactiver' if capteur_states['capteur_lumiere'] == 'Actif' else 'Activer' }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Capteur de Gaz -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Capteur de Gaz</h5>
                        <p class="card-text">√âtat : <span>{{ capteur_states['capteur_gaz'] }}</span></p>
                        <form method="POST" action="/toggle_capteur">
                            <input type="hidden" name="capteur_id" value="capteur_gaz">
                            <button type="submit" class="btn {{ 'btn-success' if capteur_states['capteur_gaz'] == 'Actif' else 'btn-danger' }}">
                                {{ 'D√©sactiver' if capteur_states['capteur_gaz'] == 'Actif' else 'Activer' }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Actionneur Lumi√®re -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Actionneur Lumi√®re</h5>
                        <p class="card-text">√âtat : <span>{{ capteur_states['actionneur_lumiere'] }}</span></p>
                        <form method="POST" action="/toggle_capteur">
                            <input type="hidden" name="capteur_id" value="actionneur_lumiere">
                            <button type="submit" class="btn {{ 'btn-success' if capteur_states['actionneur_lumiere'] == 'Actif' else 'btn-danger' }}">
                                {{ 'D√©sactiver' if capteur_states['actionneur_lumiere'] == 'Actif' else 'Activer' }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Ajout de Capteurs/Actionneurs -->
    <section id="ajout_capteurs" class="container mt-5">
        <h4>Ajout de Capteurs/Actionneurs</h4>
        <form method="POST" action="/manage_devices" class="mb-5">
            <div class="form-group">
                <label for="deviceType">Type de Capteur/Actionneur</label>
                <select class="form-control" name="deviceType" id="deviceType">
                    <option>Capteur de Temp√©rature</option>
                    <option>Capteur d'Humidit√©</option>
                    <option>Capteur de Lumi√®re</option>
                    <option>Capteur de Gaz</option>
                    <option>Actionneur Lumi√®re</option>
                </select>
            </div>
            <div class="form-group">
                <label for="roomSelect">Pi√®ce</label>
                <select class="form-control" name="roomSelect" id="roomSelect">
                    {% for room in rooms %}
                    <option value="{{ room['piece_id'] }}">{{ room['nom'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-success">Ajouter/Associer le Capteur/Actionneur</button>
        </form>
    </section>

        <!-- Configuration -->
        <section id="configuration" class="container mt-5">
            <h2>Configuration du Logement √âco-Responsable</h2>
        <!-- Manage Rooms -->
            <section id="seuils" class="container mt-5">
            <form method="POST" action="/manage_rooms" class="mb-5" id="manageRoomsForm">
                <h4>Gestion des Pi√®ces</h4>
                <div class="form-group">
                    <label for="roomAction">Action</label>
                    <select class="form-control" name="roomAction" id="roomAction" onchange="toggleFields()">
                        <option value="add">Ajouter</option>
                        <option value="edit">Modifier</option>
                        <option value="delete">Supprimer</option>
                    </select>
                </div>
                <div class="form-group" id="addOrEditName">
                    <label for="roomName">Nom de la Pi√®ce</label>
                    <input type="text" class="form-control" name="roomName" id="roomName" placeholder="Entrer le nom de la pi√®ce (e.g., Salon, Cuisine)" required>
                </div>
                <div class="form-group" id="selectRoomName" style="display: none;">
                    <label for="existingRoomName">S√©lectionner une Pi√®ce</label>
                    <select class="form-control" name="existingRoomName" id="existingRoomName">
                        {% for room in rooms %}
                            <option value="{{ room['piece_id'] }}">{{ room['nom'] }}</option>
                        {% endfor %}
                    </select>
                </div>        
                <div id="coordinateFields" class="form-group" style="display: none;">
                    <label for="coord_x">Coordonn√©e X</label>
                    <input type="number" class="form-control" name="coord_x" id="coord_x" placeholder="Coordonn√©e X" required>
                    
                    <label for="coord_y">Coordonn√©e Y</label>
                    <input type="number" class="form-control" name="coord_y" id="coord_y" placeholder="Coordonn√©e Y" required>
                    
                    <label for="coord_z">Coordonn√©e Z (√âtage)</label>
                    <input type="number" class="form-control" name="coord_z" id="coord_z" placeholder="Coordonn√©e Z (√âtage)">
                </div>
                <input type="hidden" name="_method" id="formMethod" value="POST">
                <button type="button" class="btn btn-primary" onclick="submitForm()">Enregistrer la Gestion des Pi√®ces</button>
            </form>
        </section>
    
        <script>
            function toggleFields() {
                const action = document.getElementById("roomAction").value;
                const addOrEditName = document.getElementById("addOrEditName");
                const selectRoomName = document.getElementById("selectRoomName");
                const coordinateFields = document.getElementById("coordinateFields");
                console.log(`Action choisie: ${action}`);
                
                if (action === "add") {
                    addOrEditName.style.display = "block";
                    selectRoomName.style.display = "none";
                    coordinateFields.style.display = "block";
                } else if (action === "edit") {
                    addOrEditName.style.display = "none";
                    selectRoomName.style.display = "block";
                    coordinateFields.style.display = "block";
                } else if (action === "delete") {
                    addOrEditName.style.display = "none";
                    selectRoomName.style.display = "block";
                    coordinateFields.style.display = "none";
                }
            }
    
            function submitForm() {
                const action = document.getElementById("roomAction").value;
                const formMethod = document.getElementById("formMethod");
                const form = document.getElementById("manageRoomsForm");
    
                // Set the form method based on the action
                if (action === "add") {
                    formMethod.value = "POST";
                    form.method = "POST";
                } else if (action === "edit") {
                    formMethod.value = "PUT";
                    form.method = "POST";  // Still POST to allow Flask to understand PUT via method override
                } else if (action === "delete") {
                    formMethod.value = "DELETE";
                    form.method = "POST";  // Still POST to allow Flask to understand DELETE via method override
                }
    
                // Submit the form
                form.submit();
            }
    
            document.addEventListener("DOMContentLoaded", function() {
                toggleFields();
            });
        </script>  

    <!-- Seuils de Consommation et Alertes -->
    <section id="seuils" class="container mt-5">
        <h4>Seuils de Consommation et Alertes</h4>
        <form method="POST" action="/set_thresholds" class="mb-5">
            <div class="form-group">
                <label for="electricityThreshold">Seuil de Consommation √âlectrique (kWh)</label>
                <input type="number" class="form-control" name="electricityThreshold" id="electricityThreshold" placeholder="D√©finir un seuil de consommation √©lectrique">
            </div>
            <div class="form-group">
                <label for="waterThreshold">Seuil de Consommation d'Eau (Litres)</label>
                <input type="number" class="form-control" name="waterThreshold" id="waterThreshold" placeholder="D√©finir un seuil de consommation d'eau">
            </div>
            <button type="submit" class="btn btn-warning">Enregistrer les Seuils de Consommation</button>
        </form>
    </section>

    <!-- S√©curit√© des Pi√®ces -->
    <section id="securite" class="container mt-5">
        <h4>S√©curit√© des Pi√®ces</h4>
        <form method="POST" action="/manage_security" class="mb-5">
            <div class="form-group">
                <label for="securityRoomSelect">Pi√®ce</label>
                <select class="form-control" name="securityRoomSelect" id="securityRoomSelect">
                    {% for room in rooms %}
                    <option value="{{ room['piece_id'] }}">{{ room['nom'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="lockState">Verrouiller/D√©verrouiller</label>
                <select class="form-control" name="lockState" id="lockState">
                    <option value="lock">Verrouiller</option>
                    <option value="unlock">D√©verrouiller</option>
                </select>
            </div>
            <button type="submit" class="btn btn-danger">Enregistrer la S√©curit√© de la Pi√®ce</button>
        </form>
    </section>

    <!-- Vue d'ensemble de la maison -->
    <section id="house_overview" class="container mt-5">
        <h2>Vue d'ensemble de la maison</h2>
        <div class="house-plan">
            {% for level in rooms | groupby('coord_z') %}
            <h3>√âtage: {{ level.grouper }}</h3>
            <svg width="1000" height="800" xmlns="http://www.w3.org/2000/svg" style="border: 1px solid #000; margin-bottom: 30px;">
                {% for room in level.list %}
                {% if room['coord_x'] is not none and room['coord_y'] is not none %}
                <rect x="{{ room['coord_x'] }}" y="{{ room['coord_y'] }}" width="200" height="150" fill="#87cefa" />
                <text x="{{ room['coord_x'] + 10 }}" y="{{ room['coord_y'] + 20 }}" font-size="14" font-family="Arial">{{ room['nom'] }}</text>
                <circle cx="{{ room['coord_x'] + 30 }}" cy="{{ room['coord_y'] + 50 }}" r="15" fill="orange" />
                <text x="{{ room['coord_x'] + 50 }}" y="{{ room['coord_y'] + 55 }}" font-size="12" font-family="Arial">
                    {{ room['capteurs'] }} capteurs
                </text>
                {% endif %}
                {% endfor %}
            </svg>
            {% endfor %}
        </div>
    </section>

    <script>
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawCharts);

        function drawCharts() {
            // R√©cup√©rer les donn√©es du serveur Flask
            $.getJSON('http://127.0.0.1:5000/factures_p3', function(factures) {
                if (factures.length === 0) {
                    console.error("Aucune donn√©e disponible pour les factures.");
                    return;
                }
                // Pr√©parer les donn√©es pour le graphique de consommation
                var data1 = [['Type', 'Montant']];
                factures.forEach(function(facture) {
                    data1.push([facture.type_fac, facture.montant_total]);
                });

                var options1 = {
                    title: 'Consommation du Logement',
                    is3D: true
                };

                var chart1 = new google.visualization.PieChart(document.getElementById('consommation_chart'));
                chart1.draw(google.visualization.arrayToDataTable(data1), options1);
            }).fail(function() {
                console.error("Impossible de r√©cup√©rer les donn√©es des factures.");
            });

            // R√©cup√©rer les donn√©es pour les √©conomies r√©alis√©es
            $.getJSON('http://127.0.0.1:5000/economies', function(response) {
                if (!response.data || response.data.length === 0) {
                    console.error("Aucune donn√©e disponible pour les √©conomies.");
                    return;
                }

                const months = response.months;
                const data = response.data;

                // Prepare Google Charts data
                const chartData = new google.visualization.DataTable();
                chartData.addColumn('string', 'Mois');
                data.forEach(entry => chartData.addColumn('number', entry.type_fac));

                months.forEach((month, i) => {
                    const row = [month];
                    data.forEach(entry => row.push(entry.montants[i] || 0));
                    chartData.addRow(row);
                });

                const options = {
                    title: '√âvolution des Montants par Type de Facture',
                    hAxis: { title: 'Mois' },
                    vAxis: { title: 'Montant (EUR)' },
                    legend: { position: 'top' },
                };

                const chart = new google.visualization.LineChart(document.getElementById('economies_chart'));
                chart.draw(chartData, options);
            }).fail(function() {
                console.error("Impossible de r√©cup√©rer les donn√©es des √©conomies.");
            });
        }
    </script>
</body>
</html>
